<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC63JYlboedK6hE_u4ubAT0Nm2PIo-ygQk",
  authDomain: "atmoshuddi.firebaseapp.com",
  projectId: "atmoshuddi",
  storageBucket: "atmoshuddi.appspot.com", 
  messagingSenderId: "540869594984",
  appId: "1:540869594984:web:667a69b95b6edd983ed0dd",
  measurementId: "G-X9HQ1DN4P7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const memberSelect = document.getElementById("memberSelect");
const tableBody = document.getElementById("contributionsBody");
const totalAmountCell = document.getElementById("totalAmount");

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth).then(() => window.location.href="/index.html");
});

// Members data
const members = [
  {name:"Nahidul Islam Shahin", uid:"TswpmH1sN7fRpF6Yk7eolo7Ugds2"},
  {name:"Shohrah Uddin Sowrov", uid:"wQSvWHi2QOWsqg7VxhvQp8Bq8zw1"},
  {name:"Zahedul Amin Sohag", uid:"FhS6Tb10XYeVjwv4rcfAEr7ZuV33"},
  {name:"Ziabul",uid:"cHb9uvDq5hSAUuBVloG4NR3gPof1"},
  {name:"Mojibul Alam", uid:"5VdlbmtFCYeMH6jyDYJgjqTn1uC2"},
  {name:"Jahir Amor", uid:"q1Dc1OeL95NDyRg4eFFVyl5BqbX2"},
  {name:"Abu Arif Naim", uid:"57Yysv0aWfhcNSC8awu1L1dzVTm2"},
  {name:"Nahidul Islam Tipu", uid:"PaaeyQt3RfbrSI69NlKz9gilFy32"},
  {name:"Mofiz Alam", uid:"b7F4IOjC7GNofRfx15Qd0JmUFTH3"},
  {name:"Jalal Uddin Rumi", uid:"lmP4QmU0FXQwZbKHcVvydj97TQu1"},
  {name:"Shaker Alam", uid:"ftIftWaxlBhu1hP0a4N9OqElqB73"},
  {name:"Mahbubul Alam", uid:"4ILmO5KmbUb38cySJnOM4001cEy1"},
  {name:"Nezam Uddin", uid:"bIHNGBaFHKaYd6TKlg4NwfUKcg13"}
];

// Populate dropdown
members.forEach(m => {
  const option = document.createElement("option");
  option.value = m.uid;
  option.textContent = m.name;
  memberSelect.appendChild(option);
});

let selectedUID = null;

// Drag & Drop ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
let draggedRow = null;
function makeRowsDraggable() {
  const rows = tableBody.querySelectorAll("tr");
  rows.forEach(row => {
    row.setAttribute("draggable", true);

    row.addEventListener("dragstart", () => {
      draggedRow = row;
      row.classList.add("dragging");
    });

    row.addEventListener("dragend", () => {
      draggedRow = null;
      row.classList.remove("dragging");
    });

    row.addEventListener("dragover", (e) => {
      e.preventDefault();
      const bounding = row.getBoundingClientRect();
      const offset = e.clientY - bounding.top;
      if(offset > bounding.height / 2){
        row.style["border-bottom"] = "3px solid blue";
        row.style["border-top"] = "";
      } else {
        row.style["border-top"] = "3px solid blue";
        row.style["border-bottom"] = "";
      }
    });

    row.addEventListener("dragleave", () => {
      row.style["border-bottom"] = "";
      row.style["border-top"] = "";
    });

    row.addEventListener("drop", (e) => {
      e.preventDefault();
      row.style["border-bottom"] = "";
      row.style["border-top"] = "";

      if(draggedRow !== row){
        const bounding = row.getBoundingClientRect();
        const offset = e.clientY - bounding.top;
        if(offset > bounding.height / 2){
          row.after(draggedRow);
        } else {
          row.before(draggedRow);
        }
      }
    });
  });
}

// Load contributions for selected member
memberSelect.addEventListener("change", async () => {
  tableBody.innerHTML = "";
  selectedUID = memberSelect.value;
  if(!selectedUID) return;

  const memberDoc = doc(db, "members", selectedUID);
  const snap = await getDoc(memberDoc);
  if(snap.exists()){
    const contributions = snap.data().contributions || [];
    
    // ‡¶Æ‡ßã‡¶ü ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
    let total = 0;
    contributions.forEach(item => total += item.amount);
    totalAmountCell.textContent = total;

    // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
    contributions.forEach(item => {
      const tr = document.createElement("tr");

      const tdMonth = document.createElement("td");
      tdMonth.textContent = item.month;

      const tdAmount = document.createElement("td");
      tdAmount.textContent = item.amount;

      const tdAction = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "‚ùå Delete";
      delBtn.style.background="red";
      delBtn.style.color="white";
      delBtn.style.border="none";
      delBtn.style.borderRadius="4px";
      delBtn.style.cursor="pointer";
      delBtn.addEventListener("click", async ()=> {
        if(confirm("‚ö† ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")){
          await updateDoc(memberDoc,{ contributions: arrayRemove(item) });
          tr.remove();
          totalAmountCell.textContent =
            parseInt(totalAmountCell.textContent) - item.amount;
        }
      });
      tdAction.appendChild(delBtn);

      tr.appendChild(tdMonth);
      tr.appendChild(tdAmount);
      tr.appendChild(tdAction);

      tableBody.appendChild(tr);
    });

    // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ drag ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü
    makeRowsDraggable();
  }
});

// Save contribution
document.getElementById("saveBtn").addEventListener("click", async () => {
  if(!selectedUID) return alert("‚ö† ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
  const month = document.getElementById("month").value.trim();
  const amount = parseInt(document.getElementById("amount").value.trim());
  if(!month || !amount) return alert("‚ö† ‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!");

  const memberDoc = doc(db, "members", selectedUID);
  await updateDoc(memberDoc, { contributions: arrayUnion({month, amount}) });

  document.getElementById("month").value="";
  document.getElementById("amount").value="";
  memberSelect.dispatchEvent(new Event("change")); // refresh table
  alert("‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
});

// ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶∞‡¶Æ Firestore ‡¶è ‡¶∏‡ßá‡¶≠
document.getElementById("saveOrderBtn").addEventListener("click", async () => {
  if(!selectedUID) return alert("‚ö† ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");

  const rows = tableBody.querySelectorAll("tr"); // ‡¶∂‡ßÅ‡¶ß‡ßÅ tbody-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶ø
  const newOrder = [];
  rows.forEach(r => {
    const month = r.children[0].textContent;
    const amount = parseInt(r.children[1].textContent);
    newOrder.push({month, amount});
  });

  const memberDoc = doc(db, "members", selectedUID);
  await updateDoc(memberDoc, { contributions: newOrder });
  alert("‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
});
</script>

<style>
body{font-family:Arial;text-align:center;background:#f4f4f9;margin:0;padding:0;}
header{display:flex;justify-content:space-between;align-items:center;background:#007bff;color:white;padding:10px 20px;}
header h1{margin:0;font-size:22px;}
header button{background:red;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;}
main{margin-top:30px;display:flex;flex-direction:column;align-items:center;}
select,input,button{margin:8px;padding:10px;font-size:16px;}
#saveBtn{background:green;color:white;border:none;border-radius:5px;cursor:pointer;}
#saveOrderBtn{background:orange;color:white;border:none;border-radius:5px;cursor:pointer;}
table{width:80%;margin-top:20px;border-collapse:collapse;}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:#007bff;color:white;}
tfoot td{font-weight:bold;background:#007bff;color:white;}
/* drag effect */
tr.dragging {opacity:0.5;background:#ffe0b3;}
</style>
</head>
<body>
<header>
<h1>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
<button id="excelfile" onclick="window.location.href='https://1drv.ms/f/c/920544377a6755f3/ElmgEem2iq1BpS8iaCmu2MABuZRphS_LzTgV5zJVrUOA4w'">‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤</button>
<button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
</header>

<main>
<h2>‡¶Ö‡¶¨‡¶¶‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
<select id="memberSelect">
  <option value="">-- ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
</select><br>
<input type="text" id="month" placeholder="‡¶Æ‡¶æ‡¶∏ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'‡ß®‡ß´)"><br>
<input type="number" id="amount" placeholder="‡¶Ö‡¶¨‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£"><br>
<button id="saveBtn">Save</button>

<table id="contributionsTable">
<thead>
<tr>
<th>‡¶Æ‡¶æ‡¶∏</th>
<th>‡¶Ö‡¶¨‡¶¶‡¶æ‡¶®</th>
<th>Action</th>
</tr>
</thead>
<tbody id="contributionsBody"></tbody>
<tfoot>
<tr id="totalRow">
<td>‡¶Æ‡ßã‡¶ü</td>
<td id="totalAmount">0</td>
<td></td>
</tr>
</tfoot>
</table>

<!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® -->
<button id="saveOrderBtn">üíæ Save Order</button>

</main>
</body>
</html>
